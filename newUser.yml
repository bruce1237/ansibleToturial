---
- hosts: all
  become: true
  pre_tasks:

  - name: add essentials sudo, nano, vim
    tags: always
    yum:
      name: 
        - sudo
        - python3
        - nano
        - vim 
      state: latest
      update_cache: yes
      update_only: yes

  - name: remove nano 
    tags: MV 
    package:
      name: 
        - nano
      state: removed

- hosts: all
  become: true
  tasks:
    - name: create simone user
      tags: always
      user:
        name: simone
        groups: root
          
    - name: add ssh key for simone
      tags: always
      authorized_key:
        user: simone
        key: "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDi4x2RGdfVvi4qTDVuI9xQezSh5tSCEmAnjainHmNxsttXo+NZV3mffRMNO1d2TwA2tQvVlFkdZe9b1X3esfjlwWhju+9ikx8fH6U5OHzrM2ExiJ98c7CimedjU07l/WHnzIeULDX9nEL5wEAA9V09H7e05bkAcy2t7ZWfaqAnFLF673eJCs00dARZswgo/2zv6Py3NuD57idifjDG7WltnAV0VihSveiKk99lnG3NAab7QErn6kuyaOJWrKDVb6dBWmNDCjVYrer38nEAetMQH3vkOMXA/RQv+S4twfgAvAYB9OS5gRZpCtsxTPOs7GgF/WctfBEYcYLaPxe91BjN root@dnode1.technix.com"

    - name: add sudoers file for simone
      tags: always
      copy:
        src: sudoer_simone
        dest: /etc/sudoers.d/simone
        owner: root
        group: root
        mode: 0440


- hosts: workstations
  become: true
  tasks:
    - name: install unzip
      package:
        name:
          - unzip

    - name: install terraform
      unarchive:
        src: https://releases.hashicorp.com/terraform/1.3.0-alpha20220706/terraform_1.3.0-alpha20220706_linux_amd64.zip 
        dest: /usr/local/bin
        remote_src: yes
        mode: 0755
        owner: root
        group: root


- hosts: web_servers
  become: true
  tasks:

  - name: install webserver
    tags: apache,apache2,ubuntu
    package:
      name: 
        - "{{ webServer }}" 
        - "{{ programLanguage }}"
      state: latest
      update_cache: yes

  - name: start webserver
    tags: apache,apache2,ubuntu
    service:
      name: "{{ webServer }}"
      state: started #change the httpd to started status, means start httpd service
      enabled: yes # auto-start httpd when server is up

  - name: change e-mail address for admin (require server restart)
    tags: apache, apache2, ubuntu
    lineinfile: 
      path: /etc/httpd/conf/httpd.conf
      regexp: '^ServerAdmin'
      line: thisAdmin@web.com
    register: Myhttpd

  - name: restart "{{ webServer }}"
    tags: apache, apache2, httpd
    service:
      name: "{{ webServer }}"
      state: restarted
    when: Myhttpd.changed



  - name: copy default html file to slave
    tags: apache,apache2, httpd
    copy:
      src: default_site.html
      dest: /var/www/html/newIndex.html
      owner: root
      group: root
      mode: 0644

  - name: copy default html file to slave
    tags: apache,apache2, httpd
    copy:
      src: ./abc/a.html
      dest: /var/www/html/newIndexa.html
      owner: root
      group: root
      mode: 0644


- hosts: db_servers
  become: true
  tasks:

    - name: install mariadb
      tags: centos,db,mariadb
      package:
        name: 
          - "{{ databaseServer }}"
          - "{{ databaseClient }}"
        state: latest

    - name: start "{{ databaseServer }}"
      service:
        name: mariadb
        enabled: yes
        state: restarted

- hosts: file_servers
  become: true
  tasks:
    - name: install samba package
      tags: samba
      package:
        name: samba
        stats: latest
        
